#!/usr/bin/env bash
set -euo pipefail

CONFIG_FILE="${EDGE_MOTION_CONFIG_FILE:-/etc/default/edge-motion}"
SERVICE_NAME="${EDGE_MOTION_SERVICE_NAME:-edge-motion.service}"
LANGUAGE="${EDGE_MOTION_LANG:-${LANG:-ru}}"

if [[ "$LANGUAGE" =~ ^ru ]]; then
  LANGUAGE="ru"
else
  LANGUAGE="en"
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --lang)
      shift
      LANGUAGE="${1:-$LANGUAGE}"
      ;;
    --lang=*)
      LANGUAGE="${1#*=}"
      ;;
  esac
  shift || true
done

if [[ "$LANGUAGE" != "ru" && "$LANGUAGE" != "en" ]]; then
  LANGUAGE="en"
fi

txt() {
  local ru="$1" en="$2"
  if [[ "$LANGUAGE" == "ru" ]]; then
    printf '%s' "$ru"
  else
    printf '%s' "$en"
  fi
}

DEFAULT_ARGS=(
  --no-grab
  --mode motion
  --threshold 0.06
  --hold-ms 90
  --pulse-ms 12
  --pulse-step 1.5
  --max-speed 2.4
  --accel-exponent 1.6
  --deadzone 0.07
  --scroll-axis-priority dominant
)

msg() {
  local text="$1"
  if command -v zenity >/dev/null 2>&1 && [[ -n "${DISPLAY:-}" ]]; then
    zenity --info --title="edge-motion" --width=520 --text="$text" >/dev/null 2>&1 || true
  elif command -v whiptail >/dev/null 2>&1; then
    whiptail --title "edge-motion" --msgbox "$text" 12 78
  else
    printf '\n%s\n\n' "$text"
  fi
}

confirm() {
  local text="$1"
  if command -v zenity >/dev/null 2>&1 && [[ -n "${DISPLAY:-}" ]]; then
    zenity --question --title="edge-motion" --width=520 --text="$text"
  elif command -v whiptail >/dev/null 2>&1; then
    whiptail --title "edge-motion" --yesno "$text" 12 78
  else
    read -r -p "$text [y/N]: " ans
    [[ "${ans,,}" == "y" || "${ans,,}" == "yes" ]]
  fi
}

require_root() {
  if [[ "${EUID}" -ne 0 ]]; then
    echo "$(txt '–ó–∞–ø—É—Å—Ç–∏—Ç–µ —É—Ç–∏–ª–∏—Ç—É —Å root-–ø—Ä–∞–≤–∞–º–∏: sudo edge-motion-config' 'Run this tool as root: sudo edge-motion-config')" >&2
    exit 1
  fi
}

read_current_args() {
  if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$CONFIG_FILE"
  fi

  if [[ -n "${EDGE_MOTION_ARGS:-}" ]]; then
    # shellcheck disable=SC2206
    CURRENT_ARGS=( $EDGE_MOTION_ARGS )
  else
    CURRENT_ARGS=("${DEFAULT_ARGS[@]}")
  fi
}

find_opt() {
  local key="$1"; shift
  local -a arr=("$@")
  local i
  for ((i=0; i<${#arr[@]}; i++)); do
    if [[ "${arr[i]}" == "$key" ]]; then
      if (( i + 1 < ${#arr[@]} )) && [[ "${arr[i+1]}" != --* ]]; then
        printf '%s' "${arr[i+1]}"
      else
        printf '1'
      fi
      return 0
    fi
  done
  return 1
}

build_args() {
  local mode="$1" threshold="$2" hold_ms="$3" pulse_ms="$4" pulse_step="$5" max_speed="$6" accel="$7" deadzone="$8" natural="$9" diagonal="${10}" twofinger="${11}" grab="${12}"

  NEW_ARGS=(
    --mode "$mode"
    --threshold "$threshold"
    --hold-ms "$hold_ms"
    --pulse-ms "$pulse_ms"
    --pulse-step "$pulse_step"
    --max-speed "$max_speed"
    --accel-exponent "$accel"
    --deadzone "$deadzone"
    --scroll-axis-priority dominant
  )

  if [[ "$natural" == "1" ]]; then NEW_ARGS+=(--natural-scroll); fi
  if [[ "$diagonal" == "1" ]]; then NEW_ARGS+=(--diagonal-scroll); fi
  if [[ "$twofinger" == "1" ]]; then NEW_ARGS+=(--two-finger-scroll); fi
  if [[ "$grab" == "1" ]]; then NEW_ARGS+=(--grab); else NEW_ARGS+=(--no-grab); fi
}

validate() {
  local regex="$1" value="$2"
  [[ "$value" =~ $regex ]]
}

validate_ranges() {
  local mode_v="$1" threshold_v="$2" hold_v="$3" pulse_v="$4" step_v="$5" max_v="$6" accel_v="$7" deadzone_v="$8"

  awk -v mode="$mode_v" -v t="$threshold_v" -v h="$hold_v" -v p="$pulse_v" -v s="$step_v" -v m="$max_v" -v a="$accel_v" -v d="$deadzone_v" '
    BEGIN {
      if (mode != "motion" && mode != "scroll") exit 10;
      if (!(t >= 0 && t <= 0.49)) exit 11;
      if (!(h >= 0 && h <= 5000)) exit 12;
      if (!(p >= 1 && p <= 500)) exit 13;
      if (!(s > 0 && s <= 10)) exit 14;
      if (!(m > 0 && m <= 20)) exit 15;
      if (!(a >= 1 && a <= 6)) exit 16;
      if (!(d >= 0 && d <= 0.49)) exit 17;
      exit 0;
    }
  '
}

to_scaled_int() {
  local value="$1" scale="$2"
  awk -v v="$value" -v s="$scale" 'BEGIN { printf "%d", (v * s + 0.5) }'
}

from_scaled_int() {
  local value="$1" scale="$2" precision="$3"
  awk -v v="$value" -v s="$scale" -v p="$precision" 'BEGIN { printf "%.*f", p, (v / s) }'
}

set_defaults() {
  mode="motion"
  threshold="0.06"
  hold_ms="90"
  pulse_ms="12"
  pulse_step="1.5"
  max_speed="2.4"
  accel="1.6"
  deadzone="0.07"
  natural="0"
  diagonal="0"
  twofinger="0"
  grab="0"
}

save_and_restart() {
  {
    echo "# Managed by edge-motion-config"
    echo "EDGE_MOTION_ARGS=\"${NEW_ARGS[*]}\""
  } > "$CONFIG_FILE"

  systemctl daemon-reload
  systemctl restart "$SERVICE_NAME"
}

run_manual_update() {
  local updater="${EDGE_MOTION_UPDATER_BIN:-/usr/local/bin/edge-motion-auto-update}"
  local output rc

  if [[ ! -x "$updater" ]]; then
    msg "$(txt "–ö–æ–º–∞–Ω–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $updater" "Update command not found: $updater")"
    return 1
  fi

  output="$($updater 2>&1)"
  rc=$?

  if [[ -n "$output" ]]; then
    msg "$output"
  elif [[ $rc -eq 0 ]]; then
    msg "$(txt '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞.' 'Update finished without additional output.')"
  else
    msg "$(txt "–ö–æ–º–∞–Ω–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥ $rc)." "Update command failed (exit code $rc).")"
  fi

  return $rc
}

zenity_pick_mode_and_toggles() {
  local mode_h natural_h diagonal_h twofinger_h grab_h
  local mode_values natural_values diagonal_values twofinger_values grab_values
  [[ "$mode" == "motion" ]] && mode_h="motion" || mode_h="scroll"
  [[ "$natural" == "1" ]] && natural_h="on" || natural_h="off"
  [[ "$diagonal" == "1" ]] && diagonal_h="on" || diagonal_h="off"
  [[ "$twofinger" == "1" ]] && twofinger_h="on" || twofinger_h="off"
  [[ "$grab" == "1" ]] && grab_h="on" || grab_h="off"

  [[ "$mode_h" == "motion" ]] && mode_values="motion|scroll" || mode_values="scroll|motion"
  [[ "$natural_h" == "on" ]] && natural_values="on|off" || natural_values="off|on"
  [[ "$diagonal_h" == "on" ]] && diagonal_values="on|off" || diagonal_values="off|on"
  [[ "$twofinger_h" == "on" ]] && twofinger_values="on|off" || twofinger_values="off|on"
  [[ "$grab_h" == "on" ]] && grab_values="on|off" || grab_values="off|on"

  local out
  out=$(zenity --forms --title="$(txt 'edge-motion: –∫–Ω–æ–ø–∫–∏ –∏ —Ä–µ–∂–∏–º' 'edge-motion: toggles and mode')" --width=560 \
    --text="$(txt '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏' 'Choose mode and toggles')" \
    --separator='|' \
    --add-combo="–†–µ–∂–∏–º" --combo-values="$mode_values" \
    --add-combo="Natural scroll" --combo-values="$natural_values" \
    --add-combo="Diagonal scroll" --combo-values="$diagonal_values" \
    --add-combo="Two-finger scroll" --combo-values="$twofinger_values" \
    --add-combo="Grab touchpad" --combo-values="$grab_values") || return 1

  local n d t g
  IFS='|' read -r mode_h n d t g <<<"$out"
  mode="$mode_h"
  [[ "$n" == "on" ]] && natural=1 || natural=0
  [[ "$d" == "on" ]] && diagonal=1 || diagonal=0
  [[ "$t" == "on" ]] && twofinger=1 || twofinger=0
  [[ "$g" == "on" ]] && grab=1 || grab=0
}

zenity_numeric_form() {
  local out
  out=$(zenity --forms --title="$(txt 'edge-motion: –≤–≤–æ–¥ —á–∏—Å–µ–ª' 'edge-motion: numeric input')" --width=560 \
    --text="$(txt '–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã' 'Enter numeric parameters')" --separator='|' \
    --add-entry="threshold" --add-entry="hold-ms" --add-entry="pulse-ms" \
    --add-entry="pulse-step" --add-entry="max-speed" --add-entry="accel-exponent" \
    --add-entry="deadzone") || return 1

  mode="$(find_opt --mode "${CURRENT_ARGS[@]}" || echo motion)"
  threshold="$(find_opt --threshold "${CURRENT_ARGS[@]}" || echo 0.06)"
  hold_ms="$(find_opt --hold-ms "${CURRENT_ARGS[@]}" || echo 90)"
  pulse_ms="$(find_opt --pulse-ms "${CURRENT_ARGS[@]}" || echo 12)"
  pulse_step="$(find_opt --pulse-step "${CURRENT_ARGS[@]}" || echo 1.5)"
  max_speed="$(find_opt --max-speed "${CURRENT_ARGS[@]}" || echo 2.4)"
  accel="$(find_opt --accel-exponent "${CURRENT_ARGS[@]}" || echo 1.6)"
  deadzone="$(find_opt --deadzone "${CURRENT_ARGS[@]}" || echo 0.07)"
  natural="$(find_opt --natural-scroll "${CURRENT_ARGS[@]}" || echo 0)"
  diagonal="$(find_opt --diagonal-scroll "${CURRENT_ARGS[@]}" || echo 0)"
  twofinger="$(find_opt --two-finger-scroll "${CURRENT_ARGS[@]}" || echo 0)"
  if find_opt --grab "${CURRENT_ARGS[@]}" >/dev/null; then grab=1; else grab=0; fi

  if ! validate_ranges "$mode" "$th" "$hm" "$pm" "$ps" "$ms" "$ac" "$dz"; then
    msg "$(txt '–ß–∞—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π –≤–Ω–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞.\nthreshold/deadzone: 0..0.49, hold-ms: 0..5000, pulse-ms: 1..500, pulse-step: >0..10, max-speed: >0..20, accel: 1..6' 'Some values are out of range.\nthreshold/deadzone: 0..0.49, hold-ms: 0..5000, pulse-ms: 1..500, pulse-step: >0..10, max-speed: >0..20, accel: 1..6')"
    return 1
  fi

  threshold="$th"
  hold_ms="$hm"
  pulse_ms="$pm"
  pulse_step="$ps"
  max_speed="$ms"
  accel="$ac"
  deadzone="$dz"
}

zenity_sliders() {
  local val

  val=$(zenity --scale --title="threshold" --text="–®–∏—Ä–∏–Ω–∞ –∫—Ä–∞–µ–≤–æ–π –∑–æ–Ω—ã (0.00..0.49)" \
    --value="$(to_scaled_int "$threshold" 100)" --min-value=0 --max-value=49 --step=1 --print-partial) || return 1
  threshold="$(from_scaled_int "$val" 100 2)"

  val=$(zenity --scale --title="hold-ms" --text="–ó–∞–¥–µ—Ä–∂–∫–∞ –¥–æ —Å—Ç–∞—Ä—Ç–∞ (–º—Å)" \
    --value="$hold_ms" --min-value=0 --max-value=400 --step=1 --print-partial) || return 1
  hold_ms="$val"

  val=$(zenity --scale --title="pulse-ms" --text="–ò–Ω—Ç–µ—Ä–≤–∞–ª –∏–º–ø—É–ª—å—Å–æ–≤ (–º—Å)" \
    --value="$pulse_ms" --min-value=1 --max-value=80 --step=1 --print-partial) || return 1
  pulse_ms="$val"

  val=$(zenity --scale --title="pulse-step" --text="–ë–∞–∑–æ–≤—ã–π —à–∞–≥ (0.1..5.0)" \
    --value="$(to_scaled_int "$pulse_step" 10)" --min-value=1 --max-value=50 --step=1 --print-partial) || return 1
  pulse_step="$(from_scaled_int "$val" 10 1)"

  val=$(zenity --scale --title="max-speed" --text="–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å (0.1..8.0)" \
    --value="$(to_scaled_int "$max_speed" 10)" --min-value=1 --max-value=80 --step=1 --print-partial) || return 1
  max_speed="$(from_scaled_int "$val" 10 1)"

  val=$(zenity --scale --title="accel-exponent" --text="–£—Å–∫–æ—Ä–µ–Ω–∏–µ (1.0..4.0)" \
    --value="$(to_scaled_int "$accel" 10)" --min-value=10 --max-value=40 --step=1 --print-partial) || return 1
  accel="$(from_scaled_int "$val" 10 1)"

  val=$(zenity --scale --title="deadzone" --text="–ú—ë—Ä—Ç–≤–∞—è –∑–æ–Ω–∞ (0.00..0.49)" \
    --value="$(to_scaled_int "$deadzone" 100)" --min-value=0 --max-value=49 --step=1 --print-partial) || return 1
  deadzone="$(from_scaled_int "$val" 100 2)"
}

run_text_ui() {
  while true; do
    local prompt mode_label natural_label diagonal_label twofinger_label grab_label lang_label
    if [[ "$mode" == "motion" ]]; then mode_label="$(txt '–ö—É—Ä—Å–æ—Ä (motion)' 'Cursor (motion)')"; else mode_label="$(txt '–°–∫—Ä–æ–ª–ª (scroll)' 'Scroll (scroll)')"; fi
    if [[ "$natural" == "1" ]]; then natural_label="$(txt '–í–∫–ª' 'On')"; else natural_label="$(txt '–í—ã–∫–ª' 'Off')"; fi
    if [[ "$diagonal" == "1" ]]; then diagonal_label="–í–∫–ª"; else diagonal_label="–í—ã–∫–ª"; fi
    if [[ "$twofinger" == "1" ]]; then twofinger_label="–í–∫–ª"; else twofinger_label="–í—ã–∫–ª"; fi
    if [[ "$grab" == "1" ]]; then grab_label="$(txt '–í–∫–ª' 'On')"; else grab_label="$(txt '–í—ã–∫–ª' 'Off')"; fi
    lang_label="${LANGUAGE^^}"

    prompt="$(txt '–†–µ–∂–∏–º' 'Mode'): $mode_label\nthreshold=$threshold, hold-ms=$hold_ms, pulse-ms=$pulse_ms\npulse-step=$pulse_step, max-speed=$max_speed, accel=$accel, deadzone=$deadzone\nnatural=$natural_label, diagonal=$diagonal_label, two-finger=$twofinger_label, grab=$grab_label"

    local action
    if command -v whiptail >/dev/null 2>&1; then
      action=$(whiptail --title "$(txt 'edge-motion: –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏' 'edge-motion: configuration menu')" --menu "$prompt" 24 96 14 \
        "mode" "–†–µ–∂–∏–º: $mode_label" \
        "threshold" "–®–∏—Ä–∏–Ω–∞ –∫—Ä–∞–µ–≤–æ–π –∑–æ–Ω—ã: $threshold" \
        "hold-ms" "–ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º (–º—Å): $hold_ms" \
        "pulse-ms" "–ò–Ω—Ç–µ—Ä–≤–∞–ª –∏–º–ø—É–ª—å—Å–æ–≤ (–º—Å): $pulse_ms" \
        "pulse-step" "–ë–∞–∑–æ–≤—ã–π —à–∞–≥ –∏–º–ø—É–ª—å—Å–∞: $pulse_step" \
        "max-speed" "–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å: $max_speed" \
        "accel" "–°—Ç–µ–ø–µ–Ω—å —É—Å–∫–æ—Ä–µ–Ω–∏—è: $accel" \
        "deadzone" "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –º—ë—Ä—Ç–≤–∞—è –∑–æ–Ω–∞: $deadzone" \
        "natural" "Natural scroll: $natural_label" \
        "diagonal" "–î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª: $diagonal_label" \
        "twofinger" "–°–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ 2 –ø–∞–ª—å—Ü–∞–º–∏: $twofinger_label" \
        "grab" "$(txt '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –∑–∞—Ö–≤–∞—Ç —Ç–∞—á–ø–∞–¥–∞' 'Exclusive touchpad grab'): $grab_label" \
        "lang" "$(txt '–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞' 'Interface language'): $lang_label" \
        "save" "$(txt 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å' 'üíæ Save and restart')" \
        "update" "$(txt '‚¨á –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ–π—á–∞—Å' '‚¨á Check updates now')" \
        "reset" "$(txt '‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è' '‚Ü∫ Reset to recommended defaults')" \
        "exit" "$(txt '–í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π' 'Exit without changes')" 3>&1 1>&2 2>&3) || action="exit"
    else
      echo -e "$prompt"
      read -r -p "[mode/threshold/hold-ms/pulse-ms/pulse-step/max-speed/accel/deadzone/natural/diagonal/twofinger/grab/lang/save/update/reset/exit]: " action
    fi

    case "$action" in
      mode)
        if [[ "$mode" == "motion" ]]; then mode="scroll"; else mode="motion"; fi
        ;;
      lang)
        if [[ "$LANGUAGE" == "ru" ]]; then LANGUAGE="en"; else LANGUAGE="ru"; fi
        ;;
      threshold|hold-ms|pulse-ms|pulse-step|max-speed|accel|deadzone)
        local current regex question entered
        case "$action" in
          threshold) current="$threshold"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ –∫—Ä–∞–µ–≤–æ–π –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä 0.06):" ;;
          hold-ms) current="$hold_ms"; regex='^[0-9]+$'; question="–ù–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ hold-ms –≤ –º—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä 90):" ;;
          pulse-ms) current="$pulse_ms"; regex='^[0-9]+$'; question="–ù–æ–≤—ã–π pulse-ms –≤ –º—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä 12):" ;;
          pulse-step) current="$pulse_step"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤—ã–π pulse-step (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.5):" ;;
          max-speed) current="$max_speed"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è max-speed (–Ω–∞–ø—Ä–∏–º–µ—Ä 2.4):" ;;
          accel) current="$accel"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤—ã–π accel-exponent (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.6):" ;;
          deadzone) current="$deadzone"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è deadzone (–Ω–∞–ø—Ä–∏–º–µ—Ä 0.07):" ;;
        esac

        if command -v whiptail >/dev/null 2>&1; then
          entered=$(whiptail --title "edge-motion: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" --inputbox "$question" 11 78 "$current" 3>&1 1>&2 2>&3) || continue
        else
          read -r -p "$question " entered
        fi

        if ! validate "$regex" "$entered"; then
          msg "$(txt '–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.' 'Invalid value format. Please try again.')"
          continue
        fi

        case "$action" in
          threshold) threshold="$entered" ;;
          hold-ms) hold_ms="$entered" ;;
          pulse-ms) pulse_ms="$entered" ;;
          pulse-step) pulse_step="$entered" ;;
          max-speed) max_speed="$entered" ;;
          accel) accel="$entered" ;;
          deadzone) deadzone="$entered" ;;
        esac
        ;;
      natural)
        if [[ "$natural" == "1" ]]; then natural="0"; else natural="1"; fi
        ;;
      diagonal)
        if [[ "$diagonal" == "1" ]]; then diagonal="0"; else diagonal="1"; fi
        ;;
      twofinger)
        if [[ "$twofinger" == "1" ]]; then twofinger="0"; else twofinger="1"; fi
        ;;
      grab)
        if [[ "$grab" == "1" ]]; then grab="0"; else grab="1"; fi
        ;;
      lang)
        if [[ "$LANGUAGE" == "ru" ]]; then LANGUAGE="en"; else LANGUAGE="ru"; fi
        ;;
      save)
        if ! validate_ranges "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone"; then
          msg "$(txt '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã —á–∏—Å–ª–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.' 'Check numeric ranges before saving.')"
          continue
        fi
        build_args "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone" "$natural" "$diagonal" "$twofinger" "$grab"
        if confirm "$(txt '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏?' 'Save and auto-restart the service with new settings?')"; then
          save_and_restart
          msg "$(txt '–ì–æ—Ç–æ–≤–æ ‚úÖ. –ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ $CONFIG_FILE, —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω.' 'Done ‚úÖ. Config saved to $CONFIG_FILE, service restarted.')"
          break
        fi
        ;;
      update)
        run_manual_update || true
        ;;
      reset)
        if confirm "$(txt '–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?' 'Reset parameters to recommended defaults?')"; then
          CURRENT_ARGS=("${DEFAULT_ARGS[@]}")
          mode="motion"; threshold="0.06"; hold_ms="90"; pulse_ms="12"; pulse_step="1.5"
          max_speed="2.4"; accel="1.6"; deadzone="0.07"; natural="0"; diagonal="0"; twofinger="0"; grab="0"
          msg "$(txt '–ó–Ω–∞—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ Save –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.' 'Values have been reset. Press Save to apply.')"
        fi
        ;;
      exit)
        msg "$(txt '–í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.' 'Exited without changes.')"
        break
        ;;
      *)
        msg "$(txt '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞' 'Unknown command'): $action"
        ;;
    esac
  done
}

run_zenity_ui() {
  while true; do
    local mode_label natural_label diagonal_label twofinger_label grab_label
    if [[ "$mode" == "motion" ]]; then mode_label="$(txt '–ö—É—Ä—Å–æ—Ä (motion)' 'Cursor (motion)')"; else mode_label="$(txt '–°–∫—Ä–æ–ª–ª (scroll)' 'Scroll (scroll)')"; fi
    if [[ "$natural" == "1" ]]; then natural_label="$(txt '–í–∫–ª' 'On')"; else natural_label="$(txt '–í—ã–∫–ª' 'Off')"; fi
    if [[ "$diagonal" == "1" ]]; then diagonal_label="–í–∫–ª"; else diagonal_label="–í—ã–∫–ª"; fi
    if [[ "$twofinger" == "1" ]]; then twofinger_label="–í–∫–ª"; else twofinger_label="–í—ã–∫–ª"; fi
    if [[ "$grab" == "1" ]]; then grab_label="$(txt '–í–∫–ª' 'On')"; else grab_label="$(txt '–í—ã–∫–ª' 'Off')"; fi
    lang_label="${LANGUAGE^^}"

    local summary action
    summary="–†–µ–∂–∏–º: $mode_label\nthreshold=$threshold, hold-ms=$hold_ms, pulse-ms=$pulse_ms\npulse-step=$pulse_step, max-speed=$max_speed, accel=$accel, deadzone=$deadzone\nnatural=$natural_label, diagonal=$diagonal_label, two-finger=$twofinger_label, grab=$grab_label"

    action=$(zenity --list --title="$(txt 'edge-motion: –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞' 'edge-motion: GUI configuration')" --width=760 --height=520 \
      --text="$summary" \
      --column="$(txt '–ü–∞—Ä–∞–º–µ—Ç—Ä' 'Key')" --column="$(txt '–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ' 'Current value')" \
      "mode" "$mode_label" \
      "threshold" "$threshold" \
      "hold-ms" "$hold_ms" \
      "pulse-ms" "$pulse_ms" \
      "pulse-step" "$pulse_step" \
      "max-speed" "$max_speed" \
      "accel" "$accel" \
      "deadzone" "$deadzone" \
      "natural" "$natural_label" \
      "diagonal" "$diagonal_label" \
      "twofinger" "$twofinger_label" \
      "grab" "$grab_label" \
      "lang" "${LANGUAGE^^}" \
      --ok-label="$(txt '–ò–∑–º–µ–Ω–∏—Ç—å' 'Change')" \
      --extra-button="$(txt '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' 'Save')" \
      --extra-button="$(txt '–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å' 'Update now')" \
      --extra-button="$(txt '–°–±—Ä–æ—Å–∏—Ç—å' 'Reset')" \
      --cancel-label="$(txt '–í—ã—Ö–æ–¥' 'Exit')") || break

    case "$action" in
      mode)
        if [[ "$mode" == "motion" ]]; then mode="scroll"; else mode="motion"; fi
        ;;
      lang)
        if [[ "$LANGUAGE" == "ru" ]]; then LANGUAGE="en"; else LANGUAGE="ru"; fi
        ;;
      threshold|hold-ms|pulse-ms|pulse-step|max-speed|accel|deadzone)
        local current regex question entered
        case "$action" in
          threshold) current="$threshold"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ –∫—Ä–∞–µ–≤–æ–π –∑–æ–Ω—ã (0..0.49):" ;;
          hold-ms) current="$hold_ms"; regex='^[0-9]+$'; question="–ù–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ hold-ms (0..5000):" ;;
          pulse-ms) current="$pulse_ms"; regex='^[0-9]+$'; question="–ù–æ–≤—ã–π pulse-ms (1..500):" ;;
          pulse-step) current="$pulse_step"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤—ã–π pulse-step (>0..10):" ;;
          max-speed) current="$max_speed"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è max-speed (>0..20):" ;;
          accel) current="$accel"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤—ã–π accel-exponent (1..6):" ;;
          deadzone) current="$deadzone"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è deadzone (0..0.49):" ;;
        esac

        entered=$(zenity --entry --title="$(txt 'edge-motion: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' 'edge-motion: edit value')" --text="$question" --entry-text="$current") || continue
        if ! validate "$regex" "$entered"; then
          msg "$(txt '–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è.' 'Invalid value format.')"
          continue
        fi
        case "$action" in
          threshold) threshold="$entered" ;;
          hold-ms) hold_ms="$entered" ;;
          pulse-ms) pulse_ms="$entered" ;;
          pulse-step) pulse_step="$entered" ;;
          max-speed) max_speed="$entered" ;;
          accel) accel="$entered" ;;
          deadzone) deadzone="$entered" ;;
        esac
        ;;
      "$(txt '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' 'Save')")
        if ! validate_ranges "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone"; then
          msg "$(txt '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã —á–∏—Å–ª–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.' 'Check numeric ranges before saving.')"
          continue
        fi
        build_args "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone" "$natural" "$diagonal" "$twofinger" "$grab"
        save_and_restart
        msg "$(txt '–ì–æ—Ç–æ–≤–æ ‚úÖ. –ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ $CONFIG_FILE, —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω.' 'Done ‚úÖ. Config saved to $CONFIG_FILE, service restarted.')"
        break
        ;;
      "$(txt '–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å' 'Update now')")
        run_manual_update || true
        ;;
      "$(txt '–°–±—Ä–æ—Å–∏—Ç—å' 'Reset')")
        set_defaults
        msg "$(txt '–ó–Ω–∞—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.' 'Values have been reset. Click Save to apply.')"
        ;;
      *)
        msg "$(txt '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ' 'Unknown action'): $action"
        ;;
    esac
  done
}

require_root
read_current_args

mode="$(find_opt --mode "${CURRENT_ARGS[@]}" || echo motion)"
threshold="$(find_opt --threshold "${CURRENT_ARGS[@]}" || echo 0.06)"
hold_ms="$(find_opt --hold-ms "${CURRENT_ARGS[@]}" || echo 90)"
pulse_ms="$(find_opt --pulse-ms "${CURRENT_ARGS[@]}" || echo 12)"
pulse_step="$(find_opt --pulse-step "${CURRENT_ARGS[@]}" || echo 1.5)"
max_speed="$(find_opt --max-speed "${CURRENT_ARGS[@]}" || echo 2.4)"
accel="$(find_opt --accel-exponent "${CURRENT_ARGS[@]}" || echo 1.6)"
deadzone="$(find_opt --deadzone "${CURRENT_ARGS[@]}" || echo 0.07)"
natural="$(find_opt --natural-scroll "${CURRENT_ARGS[@]}" || echo 0)"
diagonal="$(find_opt --diagonal-scroll "${CURRENT_ARGS[@]}" || echo 0)"
twofinger="$(find_opt --two-finger-scroll "${CURRENT_ARGS[@]}" || echo 0)"
if find_opt --grab "${CURRENT_ARGS[@]}" >/dev/null; then grab=1; else grab=0; fi

if command -v zenity >/dev/null 2>&1 && [[ -n "${DISPLAY:-}" ]]; then
  run_zenity_ui
else
  run_text_ui
fi
