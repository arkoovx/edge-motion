#!/usr/bin/env bash
set -euo pipefail

CONFIG_FILE="${EDGE_MOTION_CONFIG_FILE:-/etc/default/edge-motion}"
SERVICE_NAME="${EDGE_MOTION_SERVICE_NAME:-edge-motion.service}"

DEFAULT_ARGS=(
  --no-grab
  --mode motion
  --threshold 0.06
  --hold-ms 90
  --pulse-ms 12
  --pulse-step 1.5
  --max-speed 2.4
  --accel-exponent 1.6
  --deadzone 0.07
  --scroll-axis-priority dominant
)

msg() {
  local text="$1"
  if command -v zenity >/dev/null 2>&1 && [[ -n "${DISPLAY:-}" ]]; then
    zenity --info --title="edge-motion" --width=520 --text="$text" >/dev/null 2>&1 || true
  elif command -v whiptail >/dev/null 2>&1; then
    whiptail --title "edge-motion" --msgbox "$text" 12 78
  else
    printf '\n%s\n\n' "$text"
  fi
}

confirm() {
  local text="$1"
  if command -v zenity >/dev/null 2>&1 && [[ -n "${DISPLAY:-}" ]]; then
    zenity --question --title="edge-motion" --width=520 --text="$text"
  elif command -v whiptail >/dev/null 2>&1; then
    whiptail --title "edge-motion" --yesno "$text" 12 78
  else
    read -r -p "$text [y/N]: " ans
    [[ "${ans,,}" == "y" || "${ans,,}" == "yes" ]]
  fi
}

require_root() {
  if [[ "${EUID}" -ne 0 ]]; then
    echo "Run this tool as root: sudo edge-motion-config" >&2
    exit 1
  fi
}

read_current_args() {
  if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$CONFIG_FILE"
  fi

  if [[ -n "${EDGE_MOTION_ARGS:-}" ]]; then
    # shellcheck disable=SC2206
    CURRENT_ARGS=( $EDGE_MOTION_ARGS )
  else
    CURRENT_ARGS=("${DEFAULT_ARGS[@]}")
  fi
}

find_opt() {
  local key="$1"; shift
  local -a arr=("$@")
  local i
  for ((i=0; i<${#arr[@]}; i++)); do
    if [[ "${arr[i]}" == "$key" ]]; then
      if (( i + 1 < ${#arr[@]} )) && [[ "${arr[i+1]}" != --* ]]; then
        printf '%s' "${arr[i+1]}"
      else
        printf '1'
      fi
      return 0
    fi
  done
  return 1
}

build_args() {
  local mode="$1" threshold="$2" hold_ms="$3" pulse_ms="$4" pulse_step="$5" max_speed="$6" accel="$7" deadzone="$8" natural="$9" diagonal="${10}" twofinger="${11}" grab="${12}"

  NEW_ARGS=(
    --mode "$mode"
    --threshold "$threshold"
    --hold-ms "$hold_ms"
    --pulse-ms "$pulse_ms"
    --pulse-step "$pulse_step"
    --max-speed "$max_speed"
    --accel-exponent "$accel"
    --deadzone "$deadzone"
    --scroll-axis-priority dominant
  )

  if [[ "$natural" == "1" ]]; then NEW_ARGS+=(--natural-scroll); fi
  if [[ "$diagonal" == "1" ]]; then NEW_ARGS+=(--diagonal-scroll); fi
  if [[ "$twofinger" == "1" ]]; then NEW_ARGS+=(--two-finger-scroll); fi
  if [[ "$grab" == "1" ]]; then NEW_ARGS+=(--grab); else NEW_ARGS+=(--no-grab); fi
}

validate() {
  local regex="$1" value="$2"
  [[ "$value" =~ $regex ]]
}

validate_ranges() {
  local mode_v="$1" threshold_v="$2" hold_v="$3" pulse_v="$4" step_v="$5" max_v="$6" accel_v="$7" deadzone_v="$8"

  awk -v mode="$mode_v" -v t="$threshold_v" -v h="$hold_v" -v p="$pulse_v" -v s="$step_v" -v m="$max_v" -v a="$accel_v" -v d="$deadzone_v" '
    BEGIN {
      if (mode != "motion" && mode != "scroll") exit 10;
      if (!(t >= 0 && t <= 0.49)) exit 11;
      if (!(h >= 0 && h <= 5000)) exit 12;
      if (!(p >= 1 && p <= 500)) exit 13;
      if (!(s > 0 && s <= 10)) exit 14;
      if (!(m > 0 && m <= 20)) exit 15;
      if (!(a >= 1 && a <= 6)) exit 16;
      if (!(d >= 0 && d <= 0.49)) exit 17;
      exit 0;
    }
  '
}

to_scaled_int() {
  local value="$1" scale="$2"
  awk -v v="$value" -v s="$scale" 'BEGIN { printf "%d", (v * s + 0.5) }'
}

from_scaled_int() {
  local value="$1" scale="$2" precision="$3"
  awk -v v="$value" -v s="$scale" -v p="$precision" 'BEGIN { printf "%.*f", p, (v / s) }'
}

set_defaults() {
  mode="motion"
  threshold="0.06"
  hold_ms="90"
  pulse_ms="12"
  pulse_step="1.5"
  max_speed="2.4"
  accel="1.6"
  deadzone="0.07"
  natural="0"
  diagonal="0"
  twofinger="0"
  grab="0"
}

save_and_restart() {
  {
    echo "# Managed by edge-motion-config"
    echo "EDGE_MOTION_ARGS=\"${NEW_ARGS[*]}\""
  } > "$CONFIG_FILE"

  systemctl daemon-reload
  systemctl restart "$SERVICE_NAME"
}

zenity_pick_mode_and_toggles() {
  local mode_h natural_h diagonal_h twofinger_h grab_h
  local mode_values natural_values diagonal_values twofinger_values grab_values
  [[ "$mode" == "motion" ]] && mode_h="motion" || mode_h="scroll"
  [[ "$natural" == "1" ]] && natural_h="on" || natural_h="off"
  [[ "$diagonal" == "1" ]] && diagonal_h="on" || diagonal_h="off"
  [[ "$twofinger" == "1" ]] && twofinger_h="on" || twofinger_h="off"
  [[ "$grab" == "1" ]] && grab_h="on" || grab_h="off"

  [[ "$mode_h" == "motion" ]] && mode_values="motion|scroll" || mode_values="scroll|motion"
  [[ "$natural_h" == "on" ]] && natural_values="on|off" || natural_values="off|on"
  [[ "$diagonal_h" == "on" ]] && diagonal_values="on|off" || diagonal_values="off|on"
  [[ "$twofinger_h" == "on" ]] && twofinger_values="on|off" || twofinger_values="off|on"
  [[ "$grab_h" == "on" ]] && grab_values="on|off" || grab_values="off|on"

  local out
  out=$(zenity --forms --title="edge-motion: ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¸ Ñ€ÐµÐ¶Ð¸Ð¼" --width=560 \
    --text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€ÐµÐ¶Ð¸Ð¼ Ð¸ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÐµÐ»Ð¸" \
    --separator='|' \
    --add-combo="Ð ÐµÐ¶Ð¸Ð¼" --combo-values="$mode_values" \
    --add-combo="Natural scroll" --combo-values="$natural_values" \
    --add-combo="Diagonal scroll" --combo-values="$diagonal_values" \
    --add-combo="Two-finger scroll" --combo-values="$twofinger_values" \
    --add-combo="Grab touchpad" --combo-values="$grab_values") || return 1

  local n d t g
  IFS='|' read -r mode_h n d t g <<<"$out"
  mode="$mode_h"
  [[ "$n" == "on" ]] && natural=1 || natural=0
  [[ "$d" == "on" ]] && diagonal=1 || diagonal=0
  [[ "$t" == "on" ]] && twofinger=1 || twofinger=0
  [[ "$g" == "on" ]] && grab=1 || grab=0
}

zenity_numeric_form() {
  local out
  out=$(zenity --forms --title="edge-motion: Ð²Ð²Ð¾Ð´ Ñ‡Ð¸ÑÐµÐ»" --width=560 \
    --text="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹" --separator='|' \
    --add-entry="threshold" --add-entry="hold-ms" --add-entry="pulse-ms" \
    --add-entry="pulse-step" --add-entry="max-speed" --add-entry="accel-exponent" \
    --add-entry="deadzone") || return 1

  mode="$(find_opt --mode "${CURRENT_ARGS[@]}" || echo motion)"
  threshold="$(find_opt --threshold "${CURRENT_ARGS[@]}" || echo 0.06)"
  hold_ms="$(find_opt --hold-ms "${CURRENT_ARGS[@]}" || echo 90)"
  pulse_ms="$(find_opt --pulse-ms "${CURRENT_ARGS[@]}" || echo 12)"
  pulse_step="$(find_opt --pulse-step "${CURRENT_ARGS[@]}" || echo 1.5)"
  max_speed="$(find_opt --max-speed "${CURRENT_ARGS[@]}" || echo 2.4)"
  accel="$(find_opt --accel-exponent "${CURRENT_ARGS[@]}" || echo 1.6)"
  deadzone="$(find_opt --deadzone "${CURRENT_ARGS[@]}" || echo 0.07)"
  natural="$(find_opt --natural-scroll "${CURRENT_ARGS[@]}" || echo 0)"
  diagonal="$(find_opt --diagonal-scroll "${CURRENT_ARGS[@]}" || echo 0)"
  twofinger="$(find_opt --two-finger-scroll "${CURRENT_ARGS[@]}" || echo 0)"
  if find_opt --grab "${CURRENT_ARGS[@]}" >/dev/null; then grab=1; else grab=0; fi

  if ! validate_ranges "$mode" "$th" "$hm" "$pm" "$ps" "$ms" "$ac" "$dz"; then
    msg "Ð§Ð°ÑÑ‚ÑŒ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ Ð²Ð½Ðµ Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ð¾Ð³Ð¾ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°.\nthreshold/deadzone: 0..0.49, hold-ms: 0..5000, pulse-ms: 1..500, pulse-step: >0..10, max-speed: >0..20, accel: 1..6"
    return 1
  fi

  threshold="$th"
  hold_ms="$hm"
  pulse_ms="$pm"
  pulse_step="$ps"
  max_speed="$ms"
  accel="$ac"
  deadzone="$dz"
}

zenity_sliders() {
  local val

  val=$(zenity --scale --title="threshold" --text="Ð¨Ð¸Ñ€Ð¸Ð½Ð° ÐºÑ€Ð°ÐµÐ²Ð¾Ð¹ Ð·Ð¾Ð½Ñ‹ (0.00..0.49)" \
    --value="$(to_scaled_int "$threshold" 100)" --min-value=0 --max-value=49 --step=1 --print-partial) || return 1
  threshold="$(from_scaled_int "$val" 100 2)"

  val=$(zenity --scale --title="hold-ms" --text="Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð´Ð¾ ÑÑ‚Ð°Ñ€Ñ‚Ð° (Ð¼Ñ)" \
    --value="$hold_ms" --min-value=0 --max-value=400 --step=1 --print-partial) || return 1
  hold_ms="$val"

  val=$(zenity --scale --title="pulse-ms" --text="Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð¸Ð¼Ð¿ÑƒÐ»ÑŒÑÐ¾Ð² (Ð¼Ñ)" \
    --value="$pulse_ms" --min-value=1 --max-value=80 --step=1 --print-partial) || return 1
  pulse_ms="$val"

  val=$(zenity --scale --title="pulse-step" --text="Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ ÑˆÐ°Ð³ (0.1..5.0)" \
    --value="$(to_scaled_int "$pulse_step" 10)" --min-value=1 --max-value=50 --step=1 --print-partial) || return 1
  pulse_step="$(from_scaled_int "$val" 10 1)"

  val=$(zenity --scale --title="max-speed" --text="ÐœÐ°ÐºÑ. ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ (0.1..8.0)" \
    --value="$(to_scaled_int "$max_speed" 10)" --min-value=1 --max-value=80 --step=1 --print-partial) || return 1
  max_speed="$(from_scaled_int "$val" 10 1)"

  val=$(zenity --scale --title="accel-exponent" --text="Ð£ÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ðµ (1.0..4.0)" \
    --value="$(to_scaled_int "$accel" 10)" --min-value=10 --max-value=40 --step=1 --print-partial) || return 1
  accel="$(from_scaled_int "$val" 10 1)"

  val=$(zenity --scale --title="deadzone" --text="ÐœÑ‘Ñ€Ñ‚Ð²Ð°Ñ Ð·Ð¾Ð½Ð° (0.00..0.49)" \
    --value="$(to_scaled_int "$deadzone" 100)" --min-value=0 --max-value=49 --step=1 --print-partial) || return 1
  deadzone="$(from_scaled_int "$val" 100 2)"
}

run_zenity_ui() {
  while true; do
    local prompt mode_label natural_label diagonal_label twofinger_label grab_label
    if [[ "$mode" == "motion" ]]; then mode_label="ÐšÑƒÑ€ÑÐ¾Ñ€ (motion)"; else mode_label="Ð¡ÐºÑ€Ð¾Ð»Ð» (scroll)"; fi
    if [[ "$natural" == "1" ]]; then natural_label="Ð’ÐºÐ»"; else natural_label="Ð’Ñ‹ÐºÐ»"; fi
    if [[ "$diagonal" == "1" ]]; then diagonal_label="Ð’ÐºÐ»"; else diagonal_label="Ð’Ñ‹ÐºÐ»"; fi
    if [[ "$twofinger" == "1" ]]; then twofinger_label="Ð’ÐºÐ»"; else twofinger_label="Ð’Ñ‹ÐºÐ»"; fi
    if [[ "$grab" == "1" ]]; then grab_label="Ð’ÐºÐ»"; else grab_label="Ð’Ñ‹ÐºÐ»"; fi

    prompt="Ð ÐµÐ¶Ð¸Ð¼: $mode_label\nthreshold=$threshold, hold-ms=$hold_ms, pulse-ms=$pulse_ms\npulse-step=$pulse_step, max-speed=$max_speed, accel=$accel, deadzone=$deadzone\nnatural=$natural_label, diagonal=$diagonal_label, two-finger=$twofinger_label, grab=$grab_label"

    local action
    if command -v whiptail >/dev/null 2>&1; then
      action=$(whiptail --title "edge-motion: Ð¼ÐµÐ½ÑŽ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸" --menu "$prompt" 24 96 14 \
        "mode" "Ð ÐµÐ¶Ð¸Ð¼: $mode_label" \
        "threshold" "Ð¨Ð¸Ñ€Ð¸Ð½Ð° ÐºÑ€Ð°ÐµÐ²Ð¾Ð¹ Ð·Ð¾Ð½Ñ‹: $threshold" \
        "hold-ms" "Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¿ÐµÑ€ÐµÐ´ ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð¼ (Ð¼Ñ): $hold_ms" \
        "pulse-ms" "Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð¸Ð¼Ð¿ÑƒÐ»ÑŒÑÐ¾Ð² (Ð¼Ñ): $pulse_ms" \
        "pulse-step" "Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ ÑˆÐ°Ð³ Ð¸Ð¼Ð¿ÑƒÐ»ÑŒÑÐ°: $pulse_step" \
        "max-speed" "ÐœÐ°ÐºÑ. ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ: $max_speed" \
        "accel" "Ð¡Ñ‚ÐµÐ¿ÐµÐ½ÑŒ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ: $accel" \
        "deadzone" "Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð°Ñ Ð¼Ñ‘Ñ€Ñ‚Ð²Ð°Ñ Ð·Ð¾Ð½Ð°: $deadzone" \
        "natural" "Natural scroll: $natural_label" \
        "diagonal" "Ð”Ð¸Ð°Ð³Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐºÑ€Ð¾Ð»Ð»: $diagonal_label" \
        "twofinger" "Ð¡ÐºÑ€Ð¾Ð»Ð» Ñ‚Ð¾Ð»ÑŒÐºÐ¾ 2 Ð¿Ð°Ð»ÑŒÑ†Ð°Ð¼Ð¸: $twofinger_label" \
        "grab" "Ð­ÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ‹Ð¹ Ð·Ð°Ñ…Ð²Ð°Ñ‚ Ñ‚Ð°Ñ‡Ð¿Ð°Ð´Ð°: $grab_label" \
        "save" "ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ" \
        "reset" "â†º Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð½Ð° Ð¾Ð¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ" \
        "exit" "Ð’Ñ‹Ñ…Ð¾Ð´ Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹" 3>&1 1>&2 2>&3) || action="exit"
    else
      echo -e "$prompt"
      read -r -p "[mode/threshold/hold-ms/pulse-ms/pulse-step/max-speed/accel/deadzone/natural/diagonal/twofinger/grab/save/reset/exit]: " action
    fi

    case "$action" in
      mode)
        if [[ "$mode" == "motion" ]]; then mode="scroll"; else mode="motion"; fi
        ;;
      threshold|hold-ms|pulse-ms|pulse-step|max-speed|accel|deadzone)
        local current regex question entered
        case "$action" in
          threshold) current="$threshold"; regex='^[0-9]+(\.[0-9]+)?$'; question="ÐÐ¾Ð²Ð°Ñ ÑˆÐ¸Ñ€Ð¸Ð½Ð° ÐºÑ€Ð°ÐµÐ²Ð¾Ð¹ Ð·Ð¾Ð½Ñ‹ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ 0.06):" ;;
          hold-ms) current="$hold_ms"; regex='^[0-9]+$'; question="ÐÐ¾Ð²Ð°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° hold-ms Ð² Ð¼Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ 90):" ;;
          pulse-ms) current="$pulse_ms"; regex='^[0-9]+$'; question="ÐÐ¾Ð²Ñ‹Ð¹ pulse-ms Ð² Ð¼Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ 12):" ;;
          pulse-step) current="$pulse_step"; regex='^[0-9]+(\.[0-9]+)?$'; question="ÐÐ¾Ð²Ñ‹Ð¹ pulse-step (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ 1.5):" ;;
          max-speed) current="$max_speed"; regex='^[0-9]+(\.[0-9]+)?$'; question="ÐÐ¾Ð²Ð°Ñ max-speed (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ 2.4):" ;;
          accel) current="$accel"; regex='^[0-9]+(\.[0-9]+)?$'; question="ÐÐ¾Ð²Ñ‹Ð¹ accel-exponent (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ 1.6):" ;;
          deadzone) current="$deadzone"; regex='^[0-9]+(\.[0-9]+)?$'; question="ÐÐ¾Ð²Ð°Ñ deadzone (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ 0.07):" ;;
        esac

        if command -v whiptail >/dev/null 2>&1; then
          entered=$(whiptail --title "edge-motion: Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ" --inputbox "$question" 11 78 "$current" 3>&1 1>&2 2>&3) || continue
        else
          read -r -p "$question " entered
        fi

        if ! validate "$regex" "$entered"; then
          msg "ÐžÑˆÐ¸Ð±ÐºÐ° Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
          continue
        fi

        case "$action" in
          threshold) threshold="$entered" ;;
          hold-ms) hold_ms="$entered" ;;
          pulse-ms) pulse_ms="$entered" ;;
          pulse-step) pulse_step="$entered" ;;
          max-speed) max_speed="$entered" ;;
          accel) accel="$entered" ;;
          deadzone) deadzone="$entered" ;;
        esac
        ;;
      natural)
        if [[ "$natural" == "1" ]]; then natural="0"; else natural="1"; fi
        ;;
      diagonal)
        if [[ "$diagonal" == "1" ]]; then diagonal="0"; else diagonal="1"; fi
        ;;
      twofinger)
        if [[ "$twofinger" == "1" ]]; then twofinger="0"; else twofinger="1"; fi
        ;;
      grab)
        if [[ "$grab" == "1" ]]; then grab="0"; else grab="1"; fi
        ;;
      natural) [[ "$natural" == "1" ]] && natural="0" || natural="1" ;;
      diagonal) [[ "$diagonal" == "1" ]] && diagonal="0" || diagonal="1" ;;
      twofinger) [[ "$twofinger" == "1" ]] && twofinger="0" || twofinger="1" ;;
      grab) [[ "$grab" == "1" ]] && grab="0" || grab="1" ;;
      save)
        if ! validate_ranges "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone"; then
          msg "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ñ‹ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ñ… Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² Ð¿ÐµÑ€ÐµÐ´ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸ÐµÐ¼."
          continue
        fi
        build_args "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone" "$natural" "$diagonal" "$twofinger" "$grab"
        if confirm "Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ° Ñ Ð½Ð¾Ð²Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸?"; then
          save_and_restart
          msg "Ð“Ð¾Ñ‚Ð¾Ð²Ð¾ âœ…. ÐšÐ¾Ð½Ñ„Ð¸Ð³ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð² $CONFIG_FILE, ÑÐµÑ€Ð²Ð¸Ñ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½."
          break
        fi
        ;;
      reset)
        if confirm "Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð½Ð° Ð¾Ð¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ?"; then
          CURRENT_ARGS=("${DEFAULT_ARGS[@]}")
          mode="motion"; threshold="0.06"; hold_ms="90"; pulse_ms="12"; pulse_step="1.5"
          max_speed="2.4"; accel="1.6"; deadzone="0.07"; natural="0"; diagonal="0"; twofinger="0"; grab="0"
          msg "Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Save Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ."
        fi
        ;;
      exit)
        msg "Ð’Ñ‹Ñ…Ð¾Ð´ Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹."
        break
        ;;
      *)
        msg "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°: $action"
        ;;
    esac
  done
}

require_root
read_current_args

mode="$(find_opt --mode "${CURRENT_ARGS[@]}" || echo motion)"
threshold="$(find_opt --threshold "${CURRENT_ARGS[@]}" || echo 0.06)"
hold_ms="$(find_opt --hold-ms "${CURRENT_ARGS[@]}" || echo 90)"
pulse_ms="$(find_opt --pulse-ms "${CURRENT_ARGS[@]}" || echo 12)"
pulse_step="$(find_opt --pulse-step "${CURRENT_ARGS[@]}" || echo 1.5)"
max_speed="$(find_opt --max-speed "${CURRENT_ARGS[@]}" || echo 2.4)"
accel="$(find_opt --accel-exponent "${CURRENT_ARGS[@]}" || echo 1.6)"
deadzone="$(find_opt --deadzone "${CURRENT_ARGS[@]}" || echo 0.07)"
natural="$(find_opt --natural-scroll "${CURRENT_ARGS[@]}" || echo 0)"
diagonal="$(find_opt --diagonal-scroll "${CURRENT_ARGS[@]}" || echo 0)"
twofinger="$(find_opt --two-finger-scroll "${CURRENT_ARGS[@]}" || echo 0)"
if find_opt --grab "${CURRENT_ARGS[@]}" >/dev/null; then grab=1; else grab=0; fi

if command -v zenity >/dev/null 2>&1 && [[ -n "${DISPLAY:-}" ]]; then
  run_zenity_ui
else
  run_text_ui
fi
