#!/usr/bin/env bash
set -euo pipefail

CONFIG_FILE="${EDGE_MOTION_CONFIG_FILE:-/etc/default/edge-motion}"
SERVICE_NAME="${EDGE_MOTION_SERVICE_NAME:-edge-motion.service}"

DEFAULT_ARGS=(
  --no-grab
  --mode motion
  --threshold 0.06
  --hold-ms 90
  --pulse-ms 12
  --pulse-step 1.5
  --max-speed 2.4
  --accel-exponent 1.6
  --deadzone 0.07
  --scroll-axis-priority dominant
)

msg() {
  local text="$1"
  if command -v zenity >/dev/null 2>&1 && [[ -n "${DISPLAY:-}" ]]; then
    zenity --info --title="edge-motion" --width=520 --text="$text" >/dev/null 2>&1 || true
  elif command -v whiptail >/dev/null 2>&1; then
    whiptail --title "edge-motion" --msgbox "$text" 12 78
  else
    printf '\n%s\n\n' "$text"
  fi
}

confirm() {
  local text="$1"
  if command -v zenity >/dev/null 2>&1 && [[ -n "${DISPLAY:-}" ]]; then
    zenity --question --title="edge-motion" --width=520 --text="$text"
  elif command -v whiptail >/dev/null 2>&1; then
    whiptail --title "edge-motion" --yesno "$text" 12 78
  else
    read -r -p "$text [y/N]: " ans
    [[ "${ans,,}" == "y" || "${ans,,}" == "yes" ]]
  fi
}

require_root() {
  if [[ "${EUID}" -ne 0 ]]; then
    echo "Run this tool as root: sudo edge-motion-config" >&2
    exit 1
  fi
}

read_current_args() {
  if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$CONFIG_FILE"
  fi

  if [[ -n "${EDGE_MOTION_ARGS:-}" ]]; then
    # shellcheck disable=SC2206
    CURRENT_ARGS=( $EDGE_MOTION_ARGS )
  else
    CURRENT_ARGS=("${DEFAULT_ARGS[@]}")
  fi
}

find_opt() {
  local key="$1"; shift
  local -a arr=("$@")
  local i
  for ((i=0; i<${#arr[@]}; i++)); do
    if [[ "${arr[i]}" == "$key" ]]; then
      if (( i + 1 < ${#arr[@]} )) && [[ "${arr[i+1]}" != --* ]]; then
        printf '%s' "${arr[i+1]}"
      else
        printf '1'
      fi
      return 0
    fi
  done
  return 1
}

build_args() {
  local mode="$1" threshold="$2" hold_ms="$3" pulse_ms="$4" pulse_step="$5" max_speed="$6" accel="$7" deadzone="$8" natural="$9" diagonal="${10}" twofinger="${11}" grab="${12}"

  NEW_ARGS=(
    --mode "$mode"
    --threshold "$threshold"
    --hold-ms "$hold_ms"
    --pulse-ms "$pulse_ms"
    --pulse-step "$pulse_step"
    --max-speed "$max_speed"
    --accel-exponent "$accel"
    --deadzone "$deadzone"
    --scroll-axis-priority dominant
  )

  if [[ "$natural" == "1" ]]; then NEW_ARGS+=(--natural-scroll); fi
  if [[ "$diagonal" == "1" ]]; then NEW_ARGS+=(--diagonal-scroll); fi
  if [[ "$twofinger" == "1" ]]; then NEW_ARGS+=(--two-finger-scroll); fi
  if [[ "$grab" == "1" ]]; then NEW_ARGS+=(--grab); else NEW_ARGS+=(--no-grab); fi
}

validate() {
  local regex="$1" value="$2"
  [[ "$value" =~ $regex ]]
}

validate_ranges() {
  local mode_v="$1" threshold_v="$2" hold_v="$3" pulse_v="$4" step_v="$5" max_v="$6" accel_v="$7" deadzone_v="$8"

  awk -v mode="$mode_v" -v t="$threshold_v" -v h="$hold_v" -v p="$pulse_v" -v s="$step_v" -v m="$max_v" -v a="$accel_v" -v d="$deadzone_v" '
    BEGIN {
      if (mode != "motion" && mode != "scroll") exit 10;
      if (!(t >= 0 && t <= 0.49)) exit 11;
      if (!(h >= 0 && h <= 5000)) exit 12;
      if (!(p >= 1 && p <= 500)) exit 13;
      if (!(s > 0 && s <= 10)) exit 14;
      if (!(m > 0 && m <= 20)) exit 15;
      if (!(a >= 1 && a <= 6)) exit 16;
      if (!(d >= 0 && d <= 0.49)) exit 17;
      exit 0;
    }
  '
}

to_scaled_int() {
  local value="$1" scale="$2"
  awk -v v="$value" -v s="$scale" 'BEGIN { printf "%d", (v * s + 0.5) }'
}

from_scaled_int() {
  local value="$1" scale="$2" precision="$3"
  awk -v v="$value" -v s="$scale" -v p="$precision" 'BEGIN { printf "%.*f", p, (v / s) }'
}

set_defaults() {
  mode="motion"
  threshold="0.06"
  hold_ms="90"
  pulse_ms="12"
  pulse_step="1.5"
  max_speed="2.4"
  accel="1.6"
  deadzone="0.07"
  natural="0"
  diagonal="0"
  twofinger="0"
  grab="0"
}

save_and_restart() {
  {
    echo "# Managed by edge-motion-config"
    echo "EDGE_MOTION_ARGS=\"${NEW_ARGS[*]}\""
  } > "$CONFIG_FILE"

  systemctl daemon-reload
  systemctl restart "$SERVICE_NAME"
}

zenity_pick_mode_and_toggles() {
  local mode_h natural_h diagonal_h twofinger_h grab_h
  local mode_values natural_values diagonal_values twofinger_values grab_values
  [[ "$mode" == "motion" ]] && mode_h="motion" || mode_h="scroll"
  [[ "$natural" == "1" ]] && natural_h="on" || natural_h="off"
  [[ "$diagonal" == "1" ]] && diagonal_h="on" || diagonal_h="off"
  [[ "$twofinger" == "1" ]] && twofinger_h="on" || twofinger_h="off"
  [[ "$grab" == "1" ]] && grab_h="on" || grab_h="off"

  [[ "$mode_h" == "motion" ]] && mode_values="motion|scroll" || mode_values="scroll|motion"
  [[ "$natural_h" == "on" ]] && natural_values="on|off" || natural_values="off|on"
  [[ "$diagonal_h" == "on" ]] && diagonal_values="on|off" || diagonal_values="off|on"
  [[ "$twofinger_h" == "on" ]] && twofinger_values="on|off" || twofinger_values="off|on"
  [[ "$grab_h" == "on" ]] && grab_values="on|off" || grab_values="off|on"

  local out
  out=$(zenity --forms --title="edge-motion: –∫–Ω–æ–ø–∫–∏ –∏ —Ä–µ–∂–∏–º" --width=560 \
    --text="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏" \
    --separator='|' \
    --add-combo="–†–µ–∂–∏–º" --combo-values="$mode_values" \
    --add-combo="Natural scroll" --combo-values="$natural_values" \
    --add-combo="Diagonal scroll" --combo-values="$diagonal_values" \
    --add-combo="Two-finger scroll" --combo-values="$twofinger_values" \
    --add-combo="Grab touchpad" --combo-values="$grab_values") || return 1

  local n d t g
  IFS='|' read -r mode_h n d t g <<<"$out"
  mode="$mode_h"
  [[ "$n" == "on" ]] && natural=1 || natural=0
  [[ "$d" == "on" ]] && diagonal=1 || diagonal=0
  [[ "$t" == "on" ]] && twofinger=1 || twofinger=0
  [[ "$g" == "on" ]] && grab=1 || grab=0
}

zenity_numeric_form() {
  local out
  out=$(zenity --forms --title="edge-motion: –≤–≤–æ–¥ —á–∏—Å–µ–ª" --width=560 \
    --text="–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã" --separator='|' \
    --add-entry="threshold" --add-entry="hold-ms" --add-entry="pulse-ms" \
    --add-entry="pulse-step" --add-entry="max-speed" --add-entry="accel-exponent" \
    --add-entry="deadzone") || return 1

  local th hm pm ps ms ac dz
  IFS='|' read -r th hm pm ps ms ac dz <<<"$out"

  if ! validate '^[0-9]+(\.[0-9]+)?$' "$th" || \
     ! validate '^[0-9]+$' "$hm" || \
     ! validate '^[0-9]+$' "$pm" || \
     ! validate '^[0-9]+(\.[0-9]+)?$' "$ps" || \
     ! validate '^[0-9]+(\.[0-9]+)?$' "$ms" || \
     ! validate '^[0-9]+(\.[0-9]+)?$' "$ac" || \
     ! validate '^[0-9]+(\.[0-9]+)?$' "$dz"; then
    msg "–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —á–∏—Å–µ–ª. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    return 1
  fi

  if ! validate_ranges "$mode" "$th" "$hm" "$pm" "$ps" "$ms" "$ac" "$dz"; then
    msg "–ß–∞—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π –≤–Ω–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞.\nthreshold/deadzone: 0..0.49, hold-ms: 0..5000, pulse-ms: 1..500, pulse-step: >0..10, max-speed: >0..20, accel: 1..6"
    return 1
  fi

  threshold="$th"
  hold_ms="$hm"
  pulse_ms="$pm"
  pulse_step="$ps"
  max_speed="$ms"
  accel="$ac"
  deadzone="$dz"
}

zenity_sliders() {
  local val

  val=$(zenity --scale --title="threshold" --text="–®–∏—Ä–∏–Ω–∞ –∫—Ä–∞–µ–≤–æ–π –∑–æ–Ω—ã (0.00..0.49)" \
    --value="$(to_scaled_int "$threshold" 100)" --min-value=0 --max-value=49 --step=1 --print-partial) || return 1
  threshold="$(from_scaled_int "$val" 100 2)"

  val=$(zenity --scale --title="hold-ms" --text="–ó–∞–¥–µ—Ä–∂–∫–∞ –¥–æ —Å—Ç–∞—Ä—Ç–∞ (–º—Å)" \
    --value="$hold_ms" --min-value=0 --max-value=400 --step=1 --print-partial) || return 1
  hold_ms="$val"

  val=$(zenity --scale --title="pulse-ms" --text="–ò–Ω—Ç–µ—Ä–≤–∞–ª –∏–º–ø—É–ª—å—Å–æ–≤ (–º—Å)" \
    --value="$pulse_ms" --min-value=1 --max-value=80 --step=1 --print-partial) || return 1
  pulse_ms="$val"

  val=$(zenity --scale --title="pulse-step" --text="–ë–∞–∑–æ–≤—ã–π —à–∞–≥ (0.1..5.0)" \
    --value="$(to_scaled_int "$pulse_step" 10)" --min-value=1 --max-value=50 --step=1 --print-partial) || return 1
  pulse_step="$(from_scaled_int "$val" 10 1)"

  val=$(zenity --scale --title="max-speed" --text="–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å (0.1..8.0)" \
    --value="$(to_scaled_int "$max_speed" 10)" --min-value=1 --max-value=80 --step=1 --print-partial) || return 1
  max_speed="$(from_scaled_int "$val" 10 1)"

  val=$(zenity --scale --title="accel-exponent" --text="–£—Å–∫–æ—Ä–µ–Ω–∏–µ (1.0..4.0)" \
    --value="$(to_scaled_int "$accel" 10)" --min-value=10 --max-value=40 --step=1 --print-partial) || return 1
  accel="$(from_scaled_int "$val" 10 1)"

  val=$(zenity --scale --title="deadzone" --text="–ú—ë—Ä—Ç–≤–∞—è –∑–æ–Ω–∞ (0.00..0.49)" \
    --value="$(to_scaled_int "$deadzone" 100)" --min-value=0 --max-value=49 --step=1 --print-partial) || return 1
  deadzone="$(from_scaled_int "$val" 100 2)"
}

run_zenity_ui() {
  while true; do
    local mode_label
    [[ "$mode" == "motion" ]] && mode_label="–ö—É—Ä—Å–æ—Ä" || mode_label="–°–∫—Ä–æ–ª–ª"

    local action
    action=$(zenity --list --title="edge-motion: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏" --width=700 --height=420 \
      --text="–†–µ–∂–∏–º: <b>$mode_label</b> | threshold=$threshold hold=$hold_ms pulse=$pulse_ms step=$pulse_step max=$max_speed accel=$accel deadzone=$deadzone" \
      --column="–î–µ–π—Å—Ç–≤–∏–µ" --hide-header \
      "–†–µ–∂–∏–º –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ (–∫–Ω–æ–ø–∫–∏)" \
      "–ß–∏—Å–ª–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤–≤–æ–¥)" \
      "–ß–∏—Å–ª–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–æ–ª–∑—É–Ω–∫–∏)" \
      "–°–±—Ä–æ—Å–∏—Ç—å –∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º" \
      "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å" \
      "–í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π") || action="–í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π"

    case "$action" in
      "–†–µ–∂–∏–º –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ (–∫–Ω–æ–ø–∫–∏)")
        zenity_pick_mode_and_toggles || true
        ;;
      "–ß–∏—Å–ª–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤–≤–æ–¥)")
        zenity_numeric_form || true
        ;;
      "–ß–∏—Å–ª–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–æ–ª–∑—É–Ω–∫–∏)")
        zenity_sliders || true
        ;;
      "–°–±—Ä–æ—Å–∏—Ç—å –∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º")
        if confirm "–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?"; then
          set_defaults
        fi
        ;;
      "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å")
        if ! validate_ranges "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone"; then
          msg "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã —á–∏—Å–ª–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º."
          continue
        fi
        build_args "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone" "$natural" "$diagonal" "$twofinger" "$grab"
        if confirm "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å?"; then
          save_and_restart
          msg "–ì–æ—Ç–æ–≤–æ ‚úÖ –ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω."
          break
        fi
        ;;
      *)
        msg "–í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π."
        break
        ;;
    esac
  done
}

run_text_ui() {
  while true; do
    local prompt mode_label natural_label diagonal_label twofinger_label grab_label
    [[ "$mode" == "motion" ]] && mode_label="–ö—É—Ä—Å–æ—Ä (motion)" || mode_label="–°–∫—Ä–æ–ª–ª (scroll)"
    [[ "$natural" == "1" ]] && natural_label="–í–∫–ª" || natural_label="–í—ã–∫–ª"
    [[ "$diagonal" == "1" ]] && diagonal_label="–í–∫–ª" || diagonal_label="–í—ã–∫–ª"
    [[ "$twofinger" == "1" ]] && twofinger_label="–í–∫–ª" || twofinger_label="–í—ã–∫–ª"
    [[ "$grab" == "1" ]] && grab_label="–í–∫–ª" || grab_label="–í—ã–∫–ª"

    prompt="–†–µ–∂–∏–º: $mode_label\nthreshold=$threshold, hold-ms=$hold_ms, pulse-ms=$pulse_ms\npulse-step=$pulse_step, max-speed=$max_speed, accel=$accel, deadzone=$deadzone\nnatural=$natural_label, diagonal=$diagonal_label, two-finger=$twofinger_label, grab=$grab_label"

    local action
    if command -v whiptail >/dev/null 2>&1; then
      action=$(whiptail --title "edge-motion: –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏" --menu "$prompt" 24 96 14 \
        "mode" "–†–µ–∂–∏–º: $mode_label" \
        "threshold" "–®–∏—Ä–∏–Ω–∞ –∫—Ä–∞–µ–≤–æ–π –∑–æ–Ω—ã: $threshold" \
        "hold-ms" "–ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º (–º—Å): $hold_ms" \
        "pulse-ms" "–ò–Ω—Ç–µ—Ä–≤–∞–ª –∏–º–ø—É–ª—å—Å–æ–≤ (–º—Å): $pulse_ms" \
        "pulse-step" "–ë–∞–∑–æ–≤—ã–π —à–∞–≥ –∏–º–ø—É–ª—å—Å–∞: $pulse_step" \
        "max-speed" "–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å: $max_speed" \
        "accel" "–°—Ç–µ–ø–µ–Ω—å —É—Å–∫–æ—Ä–µ–Ω–∏—è: $accel" \
        "deadzone" "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –º—ë—Ä—Ç–≤–∞—è –∑–æ–Ω–∞: $deadzone" \
        "natural" "Natural scroll: $natural_label" \
        "diagonal" "–î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª: $diagonal_label" \
        "twofinger" "–°–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ 2 –ø–∞–ª—å—Ü–∞–º–∏: $twofinger_label" \
        "grab" "–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –∑–∞—Ö–≤–∞—Ç —Ç–∞—á–ø–∞–¥–∞: $grab_label" \
        "save" "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å" \
        "reset" "‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è" \
        "exit" "–í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π" 3>&1 1>&2 2>&3) || action="exit"
    else
      echo -e "$prompt"
      read -r -p "[mode/threshold/hold-ms/pulse-ms/pulse-step/max-speed/accel/deadzone/natural/diagonal/twofinger/grab/save/reset/exit]: " action
    fi

    case "$action" in
      mode) [[ "$mode" == "motion" ]] && mode="scroll" || mode="motion" ;;
      threshold|hold-ms|pulse-ms|pulse-step|max-speed|accel|deadzone)
        local current regex question entered
        case "$action" in
          threshold) current="$threshold"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ –∫—Ä–∞–µ–≤–æ–π –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä 0.06):" ;;
          hold-ms) current="$hold_ms"; regex='^[0-9]+$'; question="–ù–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ hold-ms –≤ –º—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä 90):" ;;
          pulse-ms) current="$pulse_ms"; regex='^[0-9]+$'; question="–ù–æ–≤—ã–π pulse-ms –≤ –º—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä 12):" ;;
          pulse-step) current="$pulse_step"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤—ã–π pulse-step (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.5):" ;;
          max-speed) current="$max_speed"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è max-speed (–Ω–∞–ø—Ä–∏–º–µ—Ä 2.4):" ;;
          accel) current="$accel"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤—ã–π accel-exponent (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.6):" ;;
          deadzone) current="$deadzone"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è deadzone (–Ω–∞–ø—Ä–∏–º–µ—Ä 0.07):" ;;
        esac

        if command -v whiptail >/dev/null 2>&1; then
          entered=$(whiptail --title "edge-motion: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" --inputbox "$question" 11 78 "$current" 3>&1 1>&2 2>&3) || continue
        else
          read -r -p "$question " entered
        fi

        if ! validate "$regex" "$entered"; then
          msg "–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
          continue
        fi
        local new_threshold="$threshold" new_hold_ms="$hold_ms" new_pulse_ms="$pulse_ms" new_pulse_step="$pulse_step" new_max_speed="$max_speed" new_accel="$accel" new_deadzone="$deadzone"
        case "$action" in
          threshold) new_threshold="$entered" ;;
          hold-ms) new_hold_ms="$entered" ;;
          pulse-ms) new_pulse_ms="$entered" ;;
          pulse-step) new_pulse_step="$entered" ;;
          max-speed) new_max_speed="$entered" ;;
          accel) new_accel="$entered" ;;
          deadzone) new_deadzone="$entered" ;;
        esac

        if ! validate_ranges "$mode" "$new_threshold" "$new_hold_ms" "$new_pulse_ms" "$new_pulse_step" "$new_max_speed" "$new_accel" "$new_deadzone"; then
          msg "–ó–Ω–∞—á–µ–Ω–∏–µ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ limits –≤ –ø–æ–¥—Å–∫–∞–∑–∫–µ."
          continue
        fi

        case "$action" in
          threshold) threshold="$new_threshold" ;;
          hold-ms) hold_ms="$new_hold_ms" ;;
          pulse-ms) pulse_ms="$new_pulse_ms" ;;
          pulse-step) pulse_step="$new_pulse_step" ;;
          max-speed) max_speed="$new_max_speed" ;;
          accel) accel="$new_accel" ;;
          deadzone) deadzone="$new_deadzone" ;;
        esac
        ;;
      natural) [[ "$natural" == "1" ]] && natural="0" || natural="1" ;;
      diagonal) [[ "$diagonal" == "1" ]] && diagonal="0" || diagonal="1" ;;
      twofinger) [[ "$twofinger" == "1" ]] && twofinger="0" || twofinger="1" ;;
      grab) [[ "$grab" == "1" ]] && grab="0" || grab="1" ;;
      save)
        if ! validate_ranges "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone"; then
          msg "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã —á–∏—Å–ª–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º."
          continue
        fi
        build_args "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone" "$natural" "$diagonal" "$twofinger" "$grab"
        if confirm "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏?"; then
          save_and_restart
          msg "–ì–æ—Ç–æ–≤–æ ‚úÖ. –ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ $CONFIG_FILE, —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω."
          break
        fi
        ;;
      reset)
        if confirm "–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?"; then
          set_defaults
          msg "–ó–Ω–∞—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ Save –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è."
        fi
        ;;
      exit)
        msg "–í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π."
        break
        ;;
      *)
        msg "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $action"
        ;;
    esac
  done
}

require_root
read_current_args

mode="$(find_opt --mode "${CURRENT_ARGS[@]}" || echo motion)"
threshold="$(find_opt --threshold "${CURRENT_ARGS[@]}" || echo 0.06)"
hold_ms="$(find_opt --hold-ms "${CURRENT_ARGS[@]}" || echo 90)"
pulse_ms="$(find_opt --pulse-ms "${CURRENT_ARGS[@]}" || echo 12)"
pulse_step="$(find_opt --pulse-step "${CURRENT_ARGS[@]}" || echo 1.5)"
max_speed="$(find_opt --max-speed "${CURRENT_ARGS[@]}" || echo 2.4)"
accel="$(find_opt --accel-exponent "${CURRENT_ARGS[@]}" || echo 1.6)"
deadzone="$(find_opt --deadzone "${CURRENT_ARGS[@]}" || echo 0.07)"
natural="$(find_opt --natural-scroll "${CURRENT_ARGS[@]}" || echo 0)"
diagonal="$(find_opt --diagonal-scroll "${CURRENT_ARGS[@]}" || echo 0)"
twofinger="$(find_opt --two-finger-scroll "${CURRENT_ARGS[@]}" || echo 0)"
if find_opt --grab "${CURRENT_ARGS[@]}" >/dev/null; then grab=1; else grab=0; fi

if command -v zenity >/dev/null 2>&1 && [[ -n "${DISPLAY:-}" ]]; then
  run_zenity_ui
else
  run_text_ui
fi
