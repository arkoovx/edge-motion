#!/usr/bin/env bash
set -euo pipefail

CONFIG_FILE="${EDGE_MOTION_CONFIG_FILE:-/etc/default/edge-motion}"
SERVICE_NAME="${EDGE_MOTION_SERVICE_NAME:-edge-motion.service}"

DEFAULT_ARGS=(
  --no-grab
  --mode motion
  --threshold 0.06
  --hold-ms 90
  --pulse-ms 12
  --pulse-step 1.5
  --max-speed 2.4
  --accel-exponent 1.6
  --deadzone 0.07
  --scroll-axis-priority dominant
)

msg() {
  if command -v whiptail >/dev/null 2>&1; then
    whiptail --title "edge-motion" --msgbox "$1" 12 78
  else
    printf '\n%s\n\n' "$1"
  fi
}

confirm() {
  local text="$1"
  if command -v whiptail >/dev/null 2>&1; then
    whiptail --title "edge-motion" --yesno "$text" 12 78
  else
    read -r -p "$text [y/N]: " ans
    [[ "${ans,,}" == "y" || "${ans,,}" == "yes" ]]
  fi
}

require_root() {
  if [[ "${EUID}" -ne 0 ]]; then
    echo "Run this tool as root: sudo edge-motion-config" >&2
    exit 1
  fi
}

read_current_args() {
  if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$CONFIG_FILE"
  fi

  if [[ -n "${EDGE_MOTION_ARGS:-}" ]]; then
    # shellcheck disable=SC2206
    CURRENT_ARGS=( $EDGE_MOTION_ARGS )
  else
    CURRENT_ARGS=("${DEFAULT_ARGS[@]}")
  fi
}

find_opt() {
  local key="$1"; shift
  local -a arr=("$@")
  for ((i=0; i<${#arr[@]}; i++)); do
    if [[ "${arr[i]}" == "$key" ]]; then
      if (( i + 1 < ${#arr[@]} )) && [[ "${arr[i+1]}" != --* ]]; then
        printf '%s' "${arr[i+1]}"
      else
        printf '1'
      fi
      return 0
    fi
  done
  return 1
}

build_args() {
  local mode="$1" threshold="$2" hold_ms="$3" pulse_ms="$4" pulse_step="$5" max_speed="$6" accel="$7" deadzone="$8" natural="$9" diagonal="${10}" twofinger="${11}" grab="${12}"

  NEW_ARGS=(
    --mode "$mode"
    --threshold "$threshold"
    --hold-ms "$hold_ms"
    --pulse-ms "$pulse_ms"
    --pulse-step "$pulse_step"
    --max-speed "$max_speed"
    --accel-exponent "$accel"
    --deadzone "$deadzone"
    --scroll-axis-priority dominant
  )

  if [[ "$natural" == "1" ]]; then NEW_ARGS+=(--natural-scroll); fi
  if [[ "$diagonal" == "1" ]]; then NEW_ARGS+=(--diagonal-scroll); fi
  if [[ "$twofinger" == "1" ]]; then NEW_ARGS+=(--two-finger-scroll); fi
  if [[ "$grab" == "1" ]]; then NEW_ARGS+=(--grab); else NEW_ARGS+=(--no-grab); fi
}

validate() {
  local value regex="$1"; value="$2"
  [[ "$value" =~ $regex ]]
}

save_and_restart() {
  {
    echo "# Managed by edge-motion-config"
    echo "EDGE_MOTION_ARGS=\"${NEW_ARGS[*]}\""
  } > "$CONFIG_FILE"

  systemctl daemon-reload
  systemctl restart "$SERVICE_NAME"
}

menu_loop() {
  local mode threshold hold_ms pulse_ms pulse_step max_speed accel deadzone natural diagonal twofinger grab

  mode="$(find_opt --mode "${CURRENT_ARGS[@]}" || echo motion)"
  threshold="$(find_opt --threshold "${CURRENT_ARGS[@]}" || echo 0.06)"
  hold_ms="$(find_opt --hold-ms "${CURRENT_ARGS[@]}" || echo 90)"
  pulse_ms="$(find_opt --pulse-ms "${CURRENT_ARGS[@]}" || echo 12)"
  pulse_step="$(find_opt --pulse-step "${CURRENT_ARGS[@]}" || echo 1.5)"
  max_speed="$(find_opt --max-speed "${CURRENT_ARGS[@]}" || echo 2.4)"
  accel="$(find_opt --accel-exponent "${CURRENT_ARGS[@]}" || echo 1.6)"
  deadzone="$(find_opt --deadzone "${CURRENT_ARGS[@]}" || echo 0.07)"
  natural="$(find_opt --natural-scroll "${CURRENT_ARGS[@]}" || echo 0)"
  diagonal="$(find_opt --diagonal-scroll "${CURRENT_ARGS[@]}" || echo 0)"
  twofinger="$(find_opt --two-finger-scroll "${CURRENT_ARGS[@]}" || echo 0)"
  if find_opt --grab "${CURRENT_ARGS[@]}" >/dev/null; then grab=1; else grab=0; fi

  while true; do
    local prompt mode_label natural_label diagonal_label twofinger_label grab_label
    if [[ "$mode" == "motion" ]]; then mode_label="–ö—É—Ä—Å–æ—Ä (motion)"; else mode_label="–°–∫—Ä–æ–ª–ª (scroll)"; fi
    if [[ "$natural" == "1" ]]; then natural_label="–í–∫–ª"; else natural_label="–í—ã–∫–ª"; fi
    if [[ "$diagonal" == "1" ]]; then diagonal_label="–í–∫–ª"; else diagonal_label="–í—ã–∫–ª"; fi
    if [[ "$twofinger" == "1" ]]; then twofinger_label="–í–∫–ª"; else twofinger_label="–í—ã–∫–ª"; fi
    if [[ "$grab" == "1" ]]; then grab_label="–í–∫–ª"; else grab_label="–í—ã–∫–ª"; fi

    prompt="–†–µ–∂–∏–º: $mode_label\nthreshold=$threshold, hold-ms=$hold_ms, pulse-ms=$pulse_ms\npulse-step=$pulse_step, max-speed=$max_speed, accel=$accel, deadzone=$deadzone\nnatural=$natural_label, diagonal=$diagonal_label, two-finger=$twofinger_label, grab=$grab_label"

    local action
    if command -v whiptail >/dev/null 2>&1; then
      action=$(whiptail --title "edge-motion: –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏" --menu "$prompt" 24 96 14 \
        "mode" "–†–µ–∂–∏–º: $mode_label" \
        "threshold" "–®–∏—Ä–∏–Ω–∞ –∫—Ä–∞–µ–≤–æ–π –∑–æ–Ω—ã: $threshold" \
        "hold-ms" "–ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º (–º—Å): $hold_ms" \
        "pulse-ms" "–ò–Ω—Ç–µ—Ä–≤–∞–ª –∏–º–ø—É–ª—å—Å–æ–≤ (–º—Å): $pulse_ms" \
        "pulse-step" "–ë–∞–∑–æ–≤—ã–π —à–∞–≥ –∏–º–ø—É–ª—å—Å–∞: $pulse_step" \
        "max-speed" "–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å: $max_speed" \
        "accel" "–°—Ç–µ–ø–µ–Ω—å —É—Å–∫–æ—Ä–µ–Ω–∏—è: $accel" \
        "deadzone" "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –º—ë—Ä—Ç–≤–∞—è –∑–æ–Ω–∞: $deadzone" \
        "natural" "Natural scroll: $natural_label" \
        "diagonal" "–î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª: $diagonal_label" \
        "twofinger" "–°–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ 2 –ø–∞–ª—å—Ü–∞–º–∏: $twofinger_label" \
        "grab" "–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –∑–∞—Ö–≤–∞—Ç —Ç–∞—á–ø–∞–¥–∞: $grab_label" \
        "save" "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å" \
        "reset" "‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è" \
        "exit" "–í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π" 3>&1 1>&2 2>&3) || action="exit"
    else
      echo "$prompt"
      read -r -p "[edit/save/reset/exit]: " action
    fi

    case "$action" in
      mode)
        if [[ "$mode" == "motion" ]]; then mode="scroll"; else mode="motion"; fi
        ;;
      threshold|hold-ms|pulse-ms|pulse-step|max-speed|accel|deadzone)
        local current regex question entered
        case "$action" in
          threshold) current="$threshold"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ –∫—Ä–∞–µ–≤–æ–π –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä 0.06):" ;;
          hold-ms) current="$hold_ms"; regex='^[0-9]+$'; question="–ù–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ hold-ms –≤ –º—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä 90):" ;;
          pulse-ms) current="$pulse_ms"; regex='^[0-9]+$'; question="–ù–æ–≤—ã–π pulse-ms –≤ –º—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä 12):" ;;
          pulse-step) current="$pulse_step"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤—ã–π pulse-step (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.5):" ;;
          max-speed) current="$max_speed"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è max-speed (–Ω–∞–ø—Ä–∏–º–µ—Ä 2.4):" ;;
          accel) current="$accel"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤—ã–π accel-exponent (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.6):" ;;
          deadzone) current="$deadzone"; regex='^[0-9]+(\.[0-9]+)?$'; question="–ù–æ–≤–∞—è deadzone (–Ω–∞–ø—Ä–∏–º–µ—Ä 0.07):" ;;
        esac

        if command -v whiptail >/dev/null 2>&1; then
          entered=$(whiptail --title "edge-motion: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" --inputbox "$question" 11 78 "$current" 3>&1 1>&2 2>&3) || continue
        else
          read -r -p "$question " entered
        fi

        if ! validate "$regex" "$entered"; then
          msg "–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
          continue
        fi

        case "$action" in
          threshold) threshold="$entered" ;;
          hold-ms) hold_ms="$entered" ;;
          pulse-ms) pulse_ms="$entered" ;;
          pulse-step) pulse_step="$entered" ;;
          max-speed) max_speed="$entered" ;;
          accel) accel="$entered" ;;
          deadzone) deadzone="$entered" ;;
        esac
        ;;
      natural)
        if [[ "$natural" == "1" ]]; then natural="0"; else natural="1"; fi
        ;;
      diagonal)
        if [[ "$diagonal" == "1" ]]; then diagonal="0"; else diagonal="1"; fi
        ;;
      twofinger)
        if [[ "$twofinger" == "1" ]]; then twofinger="0"; else twofinger="1"; fi
        ;;
      grab)
        if [[ "$grab" == "1" ]]; then grab="0"; else grab="1"; fi
        ;;
      save)
        build_args "$mode" "$threshold" "$hold_ms" "$pulse_ms" "$pulse_step" "$max_speed" "$accel" "$deadzone" "$natural" "$diagonal" "$twofinger" "$grab"
        if confirm "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏?"; then
          save_and_restart
          msg "–ì–æ—Ç–æ–≤–æ ‚úÖ. –ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ $CONFIG_FILE, —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω."
          break
        fi
        ;;
      reset)
        if confirm "–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?"; then
          CURRENT_ARGS=("${DEFAULT_ARGS[@]}")
          mode="motion"; threshold="0.06"; hold_ms="90"; pulse_ms="12"; pulse_step="1.5"
          max_speed="2.4"; accel="1.6"; deadzone="0.07"; natural="0"; diagonal="0"; twofinger="0"; grab="0"
          msg "–ó–Ω–∞—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ Save –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è."
        fi
        ;;
      exit)
        msg "–í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π."
        break
        ;;
      *)
        msg "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $action"
        ;;
    esac
  done
}

require_root
read_current_args
menu_loop
