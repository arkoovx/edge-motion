# edge-motion

`edge-motion` — это маленький фоновый сервис для Linux, который добавляет **edge scrolling** (прокрутку при удержании пальца у края тачпада).

Если сказать по‑простому: вы держите палец у края тачпада, а курсор плавно «ползёт» в нужную сторону. Это удобно, когда встроенная прокрутка тачпада ведёт себя неудобно или её нет.

---

## Для кого этот проект

Этот репозиторий сделан для людей, которые:

- не хотят «тонуть» в сложной Linux-настройке;
- хотят запустить всё один раз и забыть;
- хотят простой и понятный путь: **установил → проверил → подстроил скорость**.

---

## Как это правильно называется?

- По-английски чаще всего: **edge scrolling**.
- По-русски обычно говорят: «прокрутка/движение у края тачпада».

В этом проекте используется термин **edge motion**, потому что утилита генерирует относительное движение курсора.

---

## Что умеет `edge-motion`

- Автоматически находит подходящий тачпад.
- Может показать список доступных тачпадов (`--list-devices`).
- Поддерживает blacklist устройств через `--ignore /dev/input/eventX`.
- Может читать конфиг `~/.config/edge-motion.conf` (и явный `--config`).
- Есть daemon-режим (`--daemon`).
- Умеет работать с явно указанным устройством (`--device /dev/input/eventX`).
- Переподключается, если тачпад временно пропал.
- Работает как `systemd`-сервис (автозапуск после перезагрузки).
- Есть интерактивное меню `edge-motion-config` (сохранение/сброс/автоперезапуск).
- При старте сервиса выполняется безопасная авто-проверка обновлений из `main` с авто-сборкой (если настроен исходный репозиторий).

---

## Быстрый старт (Ubuntu/Debian)

### 1) Установите зависимости

```bash
sudo apt update
sudo apt install -y build-essential pkg-config libevdev-dev libudev-dev
```

### 2) Соберите проект

```bash
make build
```

### 3) Установите бинарник

```bash
sudo make install
```

### 4) Включите автозапуск через systemd

```bash
sudo make install-service
```

### 5) Проверьте, что всё запустилось

```bash
systemctl status edge-motion.service
journalctl -u edge-motion.service -f
```

---

## Настройка «под себя» (самое важное)

Сервис запускается с параметрами из файла:

`/etc/default/edge-motion`

Это переменная `EDGE_MOTION_ARGS`, которую использует systemd unit.

### Основные параметры

- `--threshold 0.06` — общий порог «зоны у края».
- `--threshold-left/--threshold-right/--threshold-top/--threshold-bottom` — отдельные пороги по сторонам.
  - меньше число (например `0.04`) → срабатывает легче;
  - больше число (например `0.08`) → нужно ближе к самому краю.
- `--hold-ms 80` — задержка перед началом движения (в миллисекундах).
- `--pulse-ms 10` — как часто отправлять движение (интервал импульсов).
- `--pulse-step 1.5` — базовая скорость движения/скролла (по умолчанию оптимизирована под плавность).

### Безопасный способ подобрать комфортные значения

- `--mode scroll` — включает режим скролла вместо движения курсора.
- `--scroll-axis-priority dominant|horizontal|vertical` — выбор приоритета оси, если `--diagonal-scroll` выключен.
- `--accel-exponent 1.8` — нелинейное ускорение ближе к краю.
- `--pressure-boost 0.5` — доп. ускорение от давления (если устройство отдает pressure).
- `--natural-scroll` — инвертирует вертикальный скролл (natural mode).
- `--diagonal-scroll` — разрешает одновременно горизонталь+вертикаль в scroll-режиме.
- `--two-finger-scroll` — edge-scroll только при двух активных пальцах.
- `--deadzone 0.08` — центральная зона, где edge-режим не активируется.
- `--grab / --no-grab` — эксклюзивный захват тачпада (`--grab`) или совместный режим (`--no-grab`, по умолчанию).

1. Меняйте **только один параметр за раз**.
2. После изменения применяйте:

```bash
sudo systemctl daemon-reload
sudo systemctl restart edge-motion.service
```

3. Проверяйте 1–2 минуты в реальной работе.
4. Если «дёргается» — чуть увеличьте `--hold-ms` или уменьшите `--pulse-step`.


### Меню настройки (user-friendly)

Запустите:

```bash
sudo edge-motion-config
```

Что умеет меню:

- Редактирование ключевых параметров в одном экране.
- Кнопка **Save**: сохраняет и автоматически делает `systemctl restart edge-motion.service`.
- Кнопка **Reset**: возвращает «оптимальные» значения по умолчанию, включая `--pulse-step 1.5`.

Параметры хранятся в `/etc/default/edge-motion` (переживают обновления и переустановку).

### Автообновление при запуске сервиса

Сервис теперь перед стартом выполняет `edge-motion-auto-update`:

- проверяет `origin/main`;
- если есть новые коммиты — собирает в отдельном временном worktree;
- устанавливает обновление **только** если сборка успешна;
- при ошибке сборки оставляет текущую рабочую версию без изменений.

Настройки автообновления: `/etc/default/edge-motion-update`

```bash
EDGE_MOTION_AUTO_UPDATE=1
EDGE_MOTION_REPO_DIR=/opt/edge-motion-src
EDGE_MOTION_UPDATE_BRANCH=main
```

> Важно: если исходники не размещены в `EDGE_MOTION_REPO_DIR`, автообновление просто тихо пропускается (без поломки существующей установки).

---

## Если тачпад не находится

Покажите список обнаруженных устройств:

```bash
sudo /usr/local/bin/edge-motion --list-devices
```

Если ваш тачпад есть в списке как `/dev/input/eventX`, задайте его явно в `ExecStart`:

```text
EDGE_MOTION_ARGS="--device /dev/input/eventX --no-grab --threshold 0.06 --hold-ms 80 --pulse-ms 10 --pulse-step 1.5"
```

---

## Команды для удаления

```bash
sudo make uninstall-service
sudo make uninstall
```

---

## Режим диагностики

Запуск в foreground с подробным выводом:

```bash
sudo /usr/local/bin/edge-motion --verbose
```

Справка по всем опциям:

```bash
/usr/local/bin/edge-motion --help
/usr/local/bin/edge-motion --version
```

---

## Как собрать вручную (без Makefile)

```bash
gcc -O2 edge-motion.c -o edge-motion $(pkg-config --cflags --libs libevdev libudev) -pthread -lm
```

---

## Типичные проблемы

- **`Missing deps` при `make build`**  
  Не установлены dev-пакеты (`libevdev-dev`, `libudev-dev`, `pkg-config`).

- **Edge-scroll работает, а остальная поверхность тачпада не работает**  
  Обычно сервис запущен с `--grab`. Уберите `--grab` или добавьте `--no-grab` в `ExecStart`, затем выполните `sudo systemctl daemon-reload && sudo systemctl restart edge-motion.service`.

- **`Не удалось создать uinput`**  
  Нужны права root (обычно запуск через systemd решает это).

- **В CI/контейнере `apt update` даёт 403**  
  Это ограничение окружения, а не ошибка проекта.
---

## Лицензия

Пока лицензия не задана отдельным файлом. Если хотите использовать проект в продукте/дистрибутиве — сначала добавьте `LICENSE`.
